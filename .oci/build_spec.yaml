version: 0.1
component: build
timeoutInSeconds: 6000
runAs: root
shell: bash

env:
  variables:
    TERRAFORM_VERSION: "1.6.0"

steps:
  - type: Command
    name: "Download Pipeline Template"
    timeoutInSeconds: 300
    command: |
      curl -H "Authorization: token $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github.v3.raw" \
        -o pipeline.sh \
        https://api.github.com/repos/vpapakir/iac-pipeline-templates/contents/oci/scripts/traffic-light-pipeline.sh
      
      chmod +x pipeline.sh
  
  - type: Command
    name: "Execute Traffic Light Pipeline"
    timeoutInSeconds: 5400
    command: |
      ./pipeline.sh \
        --ci-tool "oci_pipeline" \
        --default-cloud-provider "oci" \
        --terraform-cloud-token "$TF_CLOUD_TOKEN" \
        --github-token "$GITHUB_TOKEN" \
        --commit-sha "$OCI_BUILD_COMMIT_HASH" \
        --branch-ref "$OCI_BUILD_GIT_BRANCH" \
        --repo-name "vpapakir/iac-molecule-compute"

outputArtifacts:
  - name: output
    type: BINARY
    location: ${OCI_PRIMARY_SOURCE_DIR}