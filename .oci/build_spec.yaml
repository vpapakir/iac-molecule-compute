version: 0.1
component: build
timeoutInSeconds: 6000
runAs: root
shell: bash

env:
  variables:
    TERRAFORM_VERSION: "1.6.0"
  
  exportedVariables:
    - SHOULD_RUN
    - CLOUD_PROVIDER
    - IS_RELEASE

steps:
  - type: Command
    name: "Parse Commit Message"
    timeoutInSeconds: 300
    command: |
      # Get commit message
      COMMIT_MSG=$(git log -1 --pretty=%B 2>/dev/null | head -1 | tr -d '\n\r' || echo "")
      echo "Commit message: $COMMIT_MSG"
      
      # Check if this pipeline should run
      if [[ "$COMMIT_MSG" != *"[oci_pipeline]"* ]]; then
        echo "‚ùå Skipping - not OCI DevOps job"
        export SHOULD_RUN="false"
        exit 0
      fi
      
      echo "‚úÖ OCI DevOps should handle this"
      export SHOULD_RUN="true"
      
      # Determine cloud provider
      if [[ "$COMMIT_MSG" == *"[oci]"* ]]; then
        export CLOUD_PROVIDER="oci"
      elif [[ "$COMMIT_MSG" == *"[aws]"* ]]; then
        export CLOUD_PROVIDER="aws"
      elif [[ "$COMMIT_MSG" == *"[azure]"* ]]; then
        export CLOUD_PROVIDER="azure"
      elif [[ "$COMMIT_MSG" == *"[civo]"* ]]; then
        export CLOUD_PROVIDER="civo"
      else
        export CLOUD_PROVIDER="oci"  # default
      fi
      
      # Determine action
      if [[ "$COMMIT_MSG" == *"[release]"* ]]; then
        export IS_RELEASE="true"
      else
        export IS_RELEASE="false"
      fi
      
      echo "Cloud provider: $CLOUD_PROVIDER"
      echo "Is release: $IS_RELEASE"

  - type: Command
    name: "Install Dependencies"
    timeoutInSeconds: 600
    command: |
      if [ "$SHOULD_RUN" != "true" ]; then
        echo "Skipping - pipeline should not run"
        exit 0
      fi
      
      # Install Terraform
      wget https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
      unzip terraform_${TERRAFORM_VERSION}_linux_amd64.zip
      mv terraform /usr/local/bin/
      terraform --version
      
      # Install Python and Checkov
      yum install -y python3 python3-pip git
      pip3 install checkov

  - type: Command
    name: "Validate Terraform"
    timeoutInSeconds: 1200
    command: |
      if [ "$SHOULD_RUN" != "true" ]; then
        echo "Skipping - pipeline should not run"
        exit 0
      fi
      
      # Configure Terraform Cloud
      mkdir -p ~/.terraform.d
      echo "credentials \"app.terraform.io\" { token = \"$TF_CLOUD_TOKEN\" }" > ~/.terraform.d/credentials.tfrc.json
      
      echo "Validating $CLOUD_PROVIDER module..."
      
      # Test example if exists
      if [ -d "examples/${CLOUD_PROVIDER}-example" ]; then
        cd "examples/${CLOUD_PROVIDER}-example"
        terraform init && terraform plan && terraform validate
        cd ../..
      fi
      
      # Test module
      if [ -d "iac/terraform/${CLOUD_PROVIDER}" ]; then
        cd "iac/terraform/${CLOUD_PROVIDER}"
        terraform init && terraform fmt -check && terraform validate
        if [ "$CLOUD_PROVIDER" = "aws" ]; then
          checkov -d . --framework terraform
        fi
        cd ../../..
      fi

  - type: Command
    name: "Create Release PR"
    timeoutInSeconds: 600
    command: |
      if [ "$SHOULD_RUN" != "true" ] || [ "$IS_RELEASE" != "true" ]; then
        echo "Skipping PR creation"
        exit 0
      fi
      
      # Check if we're on main branch
      CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")
      if [ "$CURRENT_BRANCH" = "main" ]; then
        echo "On main branch - skipping PR creation"
        exit 0
      fi
      
      echo "Creating release PR..."
      
      # Install GitHub CLI
      curl -fsSL https://github.com/cli/cli/releases/download/v2.40.1/gh_2.40.1_linux_amd64.tar.gz -o gh.tar.gz
      tar -xzf gh.tar.gz && mv gh_2.40.1_linux_amd64/bin/gh /usr/local/bin/
      
      # Create PR
      echo "$GITHUB_TOKEN" | gh auth login --with-token
      
      gh pr create \
        --title "Release: ${CLOUD_PROVIDER} module updates" \
        --body "Automated release PR

      Approve with: [APPROVED] [PATCH] [oci_pipeline]" \
        --base main \
        --head "$CURRENT_BRANCH"
      
      echo "‚úÖ Release PR created"

  - type: Command
    name: "Publish Module"
    timeoutInSeconds: 600
    command: |
      if [ "$SHOULD_RUN" != "true" ]; then
        echo "Skipping - pipeline should not run"
        exit 0
      fi
      
      # Check if we're on main branch
      CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
      if [ "$CURRENT_BRANCH" != "main" ]; then
        echo "Not on main branch - skipping publish"
        exit 0
      fi
      
      # Get PR merge commit message
      MERGE_MSG=$(git log -1 --pretty=%B 2>/dev/null || echo "")
      echo "Merge message: $MERGE_MSG"
      
      # Check if this tool should publish
      if [[ "$MERGE_MSG" != *"[oci_pipeline]"* ]]; then
        echo "‚ùå Skipping publish - not approved for OCI DevOps"
        exit 0
      fi
      
      echo "‚úÖ Publishing module..."
      
      # Determine version bump
      if [[ "$MERGE_MSG" == *"[MAJOR]"* ]]; then
        BUMP_TYPE="major"
      elif [[ "$MERGE_MSG" == *"[MINOR]"* ]]; then
        BUMP_TYPE="minor"
      else
        BUMP_TYPE="patch"
      fi
      
      # Get current version and bump
      git fetch --tags
      LATEST_TAG=$(git tag -l "v*" | sort -V | tail -n1)
      
      if [ -z "$LATEST_TAG" ]; then
        NEW_VERSION="0.0.1"
      else
        CURRENT_VERSION=${LATEST_TAG#v}
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
        
        case $BUMP_TYPE in
          major) NEW_VERSION="$((MAJOR + 1)).0.0" ;;
          minor) NEW_VERSION="$MAJOR.$((MINOR + 1)).0" ;;
          patch) NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))" ;;
        esac
      fi
      
      # Configure git
      git config --global user.email "pipeline@oracle.com"
      git config --global user.name "OCI DevOps"
      
      # Create and push tag
      git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
      git remote set-url origin https://$GITHUB_TOKEN@github.com/vpapakir/iac-molecule-compute.git
      git push origin "v$NEW_VERSION"
      
      echo "üöÄ Published version: v$NEW_VERSION"

outputArtifacts:
  - name: output
    type: BINARY
    location: ${OCI_PRIMARY_SOURCE_DIR}