AWSTemplateFormatVersion: '2010-09-09'
Description: 'CodePipeline for iac-molecule-compute plan-test-release workflow'

Parameters:
  GitHubRepo:
    Type: String
    Default: 'iac-molecule-compute'
    Description: 'GitHub repository name'
  
  GitHubOwner:
    Type: String
    Description: 'GitHub repository owner'
  
  GitHubToken:
    Type: String
    NoEcho: true
    Description: 'GitHub personal access token'
  
  GitHubBranch:
    Type: String
    Default: 'main'
    Description: 'GitHub branch to monitor (main or master)'
    AllowedValues:
      - main
      - master

Resources:
  # S3 Bucket for pipeline artifacts
  ArtifactsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-pipeline-artifacts'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # IAM Role for CodePipeline
  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: PipelinePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                Resource: !Sub '${ArtifactsBucket}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !Ref ArtifactsBucket
              - Effect: Allow
                Action:
                  - codebuild:BatchGetBuilds
                  - codebuild:StartBuild
                Resource: 
                  - !GetAtt CommitCheckBuild.Arn
                  - !GetAtt PlanBuild.Arn
                  - !GetAtt TestBuild.Arn
                  - !GetAtt ReleaseBuild.Arn

  # IAM Role for CodeBuild
  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: BuildPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                Resource: !Sub '${ArtifactsBucket}/*'

  # CodeBuild Project for Commit Check
  CommitCheckBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub '${AWS::StackName}-commit-check'
      ServiceRole: !GetAtt CodeBuildRole.Arn
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:3.0
      Source:
        Type: CODEPIPELINE
        BuildSpec: |
          version: 0.2
          phases:
            build:
              commands:
                - |
                  COMMIT_MSG=$(git log -1 --pretty=%B)
                  if [[ "$COMMIT_MSG" == *"[aws]"* ]] || [[ "$COMMIT_MSG" != *"[ado]"* && "$COMMIT_MSG" != *"[gh]"* ]]; then
                    echo "Pipeline should run for AWS"
                    exit 0
                  else
                    echo "Pipeline should not run for AWS - commit message: $COMMIT_MSG"
                    exit 1
                  fi

  # CodeBuild Project for Plan
  PlanBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub '${AWS::StackName}-plan'
      ServiceRole: !GetAtt CodeBuildRole.Arn
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:3.0
      Source:
        Type: CODEPIPELINE
        BuildSpec: |
          version: 0.2
          phases:
            install:
              runtime-versions:
                python: 3.8
              commands:
                - wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
                - unzip terraform_1.6.0_linux_amd64.zip
                - mv terraform /usr/local/bin/
                - terraform --version
            pre_build:
              commands:
                - echo "Initializing Terraform..."
                - cd iac/terraform/aws
                - terraform init
                - cd ../azure
                - terraform init
                - cd ../../..
            build:
              commands:
                - echo "Running Terraform plan..."
                - cd iac/terraform/aws
                - terraform plan
                - cd ../azure
                - terraform plan
                - cd ../../..
                - echo "Plan completed successfully"

  # CodeBuild Project for Test
  TestBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub '${AWS::StackName}-test'
      ServiceRole: !GetAtt CodeBuildRole.Arn
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:3.0
      Source:
        Type: CODEPIPELINE
        BuildSpec: |
          version: 0.2
          phases:
            install:
              runtime-versions:
                python: 3.8
              commands:
                - pip install tflint checkov
                - wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
                - unzip terraform_1.6.0_linux_amd64.zip
                - mv terraform /usr/local/bin/
            build:
              commands:
                - echo "Running linting and security checks..."
                - cd iac/terraform/aws
                - terraform fmt -check
                - terraform validate
                - checkov -f . --framework terraform
                - cd ../azure
                - terraform fmt -check
                - terraform validate
                - checkov -f . --framework terraform
                - echo "All tests passed"

  # CodeBuild Project for Release
  ReleaseBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub '${AWS::StackName}-release'
      ServiceRole: !GetAtt CodeBuildRole.Arn
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:3.0
      Source:
        Type: CODEPIPELINE
        BuildSpec: |
          version: 0.2
          phases:
            install:
              commands:
                - echo "Installing Git and Terraform Cloud CLI..."
                - yum install -y git
                - wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
                - unzip terraform_1.6.0_linux_amd64.zip
                - mv terraform /usr/local/bin/
            build:
              commands:
                - echo "Publishing modules to Terraform Cloud..."
                - |
                  # Generate version based on build number and commit
                  VERSION="0.1.${CODEBUILD_BUILD_NUMBER}-$(echo ${CODEBUILD_RESOLVED_SOURCE_VERSION} | cut -c1-7)"
                  echo "Publishing version: $VERSION"
                  
                  # Create git tag for this version
                  git config user.email "pipeline@company.com"
                  git config user.name "AWS CodeBuild"
                  git tag -a "v$VERSION" -m "Automated release v$VERSION"
                  git push origin "v$VERSION"
                  
                  echo "Modules published with version: v$VERSION"

  # CodePipeline
  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Sub '${AWS::StackName}-pipeline'
      RoleArn: !GetAtt CodePipelineRole.Arn
      ArtifactStore:
        Type: S3
        Location: !Ref ArtifactsBucket
      Stages:
        - Name: Source
          Actions:
            - Name: SourceAction
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: '1'
              Configuration:
                Owner: !Ref GitHubOwner
                Repo: !Ref GitHubRepo
                Branch: !Ref GitHubBranch
                OAuthToken: !Ref GitHubToken
              OutputArtifacts:
                - Name: SourceOutput

        - Name: CommitCheck
          Actions:
            - Name: CheckCommitMessage
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref CommitCheckBuild
              InputArtifacts:
                - Name: SourceOutput
              OutputArtifacts:
                - Name: CommitCheckOutput

        - Name: Plan
          Actions:
            - Name: TerraformPlan
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref PlanBuild
              InputArtifacts:
                - Name: SourceOutput
              OutputArtifacts:
                - Name: PlanOutput

        - Name: Test
          Actions:
            - Name: LintAndSecurityScan
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref TestBuild
              InputArtifacts:
                - Name: SourceOutput
              OutputArtifacts:
                - Name: TestOutput

        - Name: Release
          Actions:
            - Name: PublishModules
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref ReleaseBuild
              InputArtifacts:
                - Name: SourceOutput
              RunOrder: 1

Outputs:
  PipelineName:
    Description: 'Name of the CodePipeline'
    Value: !Ref Pipeline
  
  ArtifactsBucket:
    Description: 'S3 bucket for pipeline artifacts'
    Value: !Ref ArtifactsBucket