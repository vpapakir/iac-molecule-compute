jobs:
- job: CreatePullRequest
  displayName: 'Create Pull Request to Main'
  steps:
  - script: |
      echo "Installing GitHub CLI..."
      curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
      sudo apt update
      sudo apt install gh -y
      
      echo "Creating pull request to main branch..."
      
      # Get current branch name from Azure DevOps variables
      CURRENT_BRANCH="$(Build.SourceBranchName)"
      echo "Current branch: $CURRENT_BRANCH"
      
      # Determine target branch (main or master)
      git fetch origin
      if git ls-remote --heads origin main | grep -q main; then
        TARGET_BRANCH="main"
      else
        TARGET_BRANCH="master"
      fi
      echo "Target branch: $TARGET_BRANCH"
      
      # Create PR title and body
      COMMIT_MSG="$(Build.SourceVersionMessage)"
      PR_TITLE="Release: $COMMIT_MSG"
      PR_BODY="Automated release PR created from commit: $(Build.SourceVersion)

      Changes:
      - Module updates ready for release
      - All tests passed
      - Security scans completed
      
      This PR was automatically created because [release] was found in the commit message."
      
      echo "Authenticating with GitHub..."
      echo "$GH_TOKEN" | gh auth login --with-token
      
      # Create PR using GitHub CLI
      gh pr create \
        --title "$PR_TITLE" \
        --body "$PR_BODY" \
        --head "$CURRENT_BRANCH" \
        --base "$TARGET_BRANCH"
      
      echo "Pull request created successfully"
    displayName: 'Create Pull Request'
    env:
      GH_TOKEN: $(GITHUB_TOKEN)